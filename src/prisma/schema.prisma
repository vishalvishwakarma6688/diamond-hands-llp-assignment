generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String         @id @default(cuid())
  email        String?        @unique
  name         String?
  rewardEvents RewardEvent[]
  stockLines   StockUnitLine[]
}

model RewardEvent {
  id              String        @id @default(cuid())
  user            User          @relation(fields: [userId], references: [id])
  userId          String
  symbol          String
  units           Decimal       @db.Decimal(18, 6)
  pricePerUnit    Decimal       @db.Decimal(18, 4) 
  feesInr         Decimal       @db.Decimal(18, 4)
  totalInr        Decimal       @db.Decimal(18, 4)
  timestamp       DateTime      @default(now())
  idempotencyKey  String?       @unique
  journalEntry    JournalEntry? @relation("RewardJournal", fields: [journalEntryId], references: [id])
  journalEntryId  String?
}

model JournalEntry {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  description   String?
  journalLines  JournalLine[]
  stockLines    StockUnitLine[]
  rewardEvents  RewardEvent[]  @relation("RewardJournal")
}


model JournalLine {
  id             String   @id @default(cuid())
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  journalEntryId String
  account        String   
  amountInr      Decimal  @db.Decimal(18, 4)
  entryType      String  
}

model StockUnitLine {
  id             String   @id @default(cuid())
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  journalEntryId String
  user           User?    @relation(fields: [userId], references: [id])
  userId         String?
  symbol         String
  unitsDelta     Decimal  @db.Decimal(18, 6)
  createdAt      DateTime @default(now())
}

model PriceHistory {
  id        String   @id @default(cuid())
  symbol    String
  priceInr  Decimal  @db.Decimal(18, 4)
  fetchedAt DateTime @default(now())

  @@index([symbol, fetchedAt])
}
